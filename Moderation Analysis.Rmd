---
title: "Moderation Analysis"
author: "Anand Rajan"
date: "4/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Moderation Analysis 

To summarize the exploratory analyses, we found that race and sex were confounding factors to the association between childhood trauma and cognition. Now that we have created multiple visualizations and evaluated confounding, we will move into the crux of our analysis - moderation analysis. We will be specifically focusing on how substance abuse moderates the association between trauma and cognition. To outline our analysis, it will be broken down into three sections: Composite cognition, Episodic Memory, Executive Functioning. To evaluate moderation, we will both look at aggregated substance abuse and break down by each substance.  We will construct linear mixed models to evaluate the significance of interaction terms and then compare the interaction models to the null model without substance abuse and model without interaction effect. Linear mixed models were utilized since the data set is not independent. Participants would sampled through cluster sampling, thus we see participants from the same family. This violates the assumption of independence as there is likely relationships between different observations. 

```{r echo=FALSE}
library(tidyverse)
library(nlme)
library(lme4)
library(haven)
library(readr)
library(stringr)
library(geepack)
library(lmerTest)
library(merTools)
library(emmeans)
library(stargazer)
library(sjPlot)
library(report)
```

```{r}
midus <-
midus_df %>% 
  mutate(
    age = coalesce(BACRAGE,B1PAGE_M2),
    sex = coalesce(B1PRSEX,BACRSEX),
    race=coalesce(B1PF7A,BACF7A),
    education = coalesce(B1PB1,BACB1),
    tranquilizer = coalesce(B1SA62A,BACAS62A),
    stimulants = coalesce(B1SA62B,BACAS62B),
    painkillers = coalesce(B1SA62C,BACAS62C),
    depressants = coalesce(B1SA62D,BACAS62D),
    inhallants = coalesce(B1SA62E,BACAS62E),
    marijuana = coalesce(B1SA62F,BACAS62F),
    cocaine = coalesce(B1SA62G,BACAS62G),
    hallucinogens = coalesce(B1SA62H,BACAS62H),
    heroin = coalesce(B1SA62J,BACAS62J)
  ) %>% 
  rename(
    composite_cognition = B3TCOMPZ3,
    episodic_memory = B3TEMZ3,
    executive_func = B3TEFZ3,
    ses_index = B1PTSEI,
    family_id = M2FAMNUM
  ) %>% 
  filter(
    race %in% (1:6)
  ) %>% 
  mutate(
    race = as.factor(race),
    sex = as.factor(sex),
    education = as.factor(education),
    tranquilizer = as.factor(tranquilizer),
    stimulants = as.factor(stimulants),
    painkillers = as.factor(painkillers),
    depressants = as.factor(depressants),
    inhallants = as.factor(inhallants),
    marijuana = as.factor(marijuana),
    cocaine = as.factor(hallucinogens),
    hallucinogens = as.factor(hallucinogens),
    heroin = as.factor(heroin)
  ) %>% 
  mutate(
    tranquilizer = recode(tranquilizer,
                           '1' = "Yes",
                           '2' = "No"),
    stimulants = recode(stimulants,
                           '1' = "Yes",
                           '2' = "No"),
    painkillers = recode(painkillers,
                           '1' = "Yes",
                           '2' = "No"),
    depressants = recode(depressants,
                           '1' = "Yes",
                           '2' = "No"),
    inhallants = recode(inhallants,
                           '1' = "Yes",
                           '2' = "No"),
    marijuana = recode(marijuana,
                           '1' = "Yes",
                           '2' = "No"),
    cocaine = recode(cocaine,
                           '1' = "Yes",
                           '2' = "No"),
    hallucinogens = recode(hallucinogens,
                           '1' = "Yes",
                           '2' = "No"),
    heroin = recode(heroin,
                           '1' = "Yes",
                           '2' = "No"),
    race = recode(race,
                            '1' = "White",
                            '2' = "Black",
                            '3' = "Native American",
                            '4' = "Asian",
                            '5' = "Native Hawaiian or Pacific Islander",
                            '6'= "Other"
                  ),
    sex= recode(sex,
                '1'="Male",
                '2'="Female"),
    education = recode(education,
                       '1'='2')
  ) %>% 
  mutate(
    drug_use = case_when(tranquilizer == 'Yes'| stimulants == 'Yes'| painkillers == 'Yes'| depressants == 'Yes' | inhallants == 'Yes' | marijuana == 'Yes' | cocaine == 'Yes' | heroin == 'Yes'  ~ 'Yes',
                         TRUE ~ 'No')
  ) %>% 
  select(family_id,age,sex,race,education,tranquilizer,stimulants,painkillers,depressants,inhallants,marijuana,cocaine,hallucinogens,heroin,composite_cognition,episodic_memory,executive_func,threat,deprivation, drug_use) %>% 
  janitor::clean_names()
```

## Drug Use

Before we dive into our analysis, let us take a quick look at substance abuse in the dataset.

```{r}
midus %>% 
  group_by(drug_use) %>% 
  summarize(n_obs=n())
```

From this table we see the proportion of those who used ANY substance is low ~ 9.6%(n=106). This low proportion should be noted as we interpret our models and the moderation effect of substance abuse.  

```{r}

```



```{r}
midus$composite_cognition <- scale(midus$composite_cognition , center = TRUE, scale = TRUE)
```

## Composite Cognition

We will begin our moderation analysis by looking at composite cognition as our outcome variable. Before we dive in we will look create a null model to evaluate the unadjusted association between trauma composite cognition.

```{r}
null_model_composite <-lmer(composite_cognition ~ threat + deprivation + (1|family_id), data=midus)

summary(null_model_composite)
confint(null_model_composite, level = 0.95, method = "Wald")
plotREsim(REsim(null_model_composite))
```
From fixed effects of this null model, we conclude that threat and deprivation are not significant predictors at the significance level of 0.05. Moreover if we look at the confidence interval for each of the parameters they include 0.  However, it should be noted that the association between threat and deprivation is confounded by a multitude of factors as stated in our exploratory analysis. These factors are sex and race. Moreover since age and education are significantly associated with composite cognition, we will include them in our full model with covariates. One final point of the model the differences between families explains 53.8% of variance  after the variance explained by our fixed effects.  


```{r}
model_covariates <- lmer(composite_cognition ~ threat + deprivation + age + sex + race + education + drug_use + (1|family_id), data=midus)

summary(model_covariates)

```
We see from the model above that despite adding the covariates, deprivation and threat are still not considered significant predictors in composite cognition at the significance level of 0.05. However from the model we glean that sex, age, and higher level education are significant predictors in composite cognition score.It is important to note that substance abuse is also not significant in this model.  Confidence intervals of the parameters confirm this. Lets now look at the effects plot. 

```{r}
confint(model_covariates, level = 0.95, method = "Wald")
plotREsim(REsim(model_covariates))
```


Model with Interactions

```{r}
model_covariates_interactions <- lmer(composite_cognition ~ threat + deprivation + age + sex + race + education + drug_use + threat*drug_use + deprivation*drug_use + (1|family_id), data=midus)

summary(model_covariates_interactions)
```


From the model, we see that the interaction between threat and overall substance abuse is not significant and the interaction between deprivation and drug_use is not significant either. We will now visualize the differential effects.


```{r}
ggplot(aes(threat,composite_cognition), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```


```{r}
ggplot(aes(deprivation,composite_cognition), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```


The two plots confirm this result as well. 



```{r}

m_threat<- mean(midus$threat, na.rm = TRUE)
sd_threat<- sd(midus$threat, na.rm = TRUE)

emm <- emmeans(model_covariates_interactions, pairwise ~ threat*drug_use, cov.keep = 3, at = list(
  threat = c(m_threat-sd_threat, m_threat, m_threat+sd_threat)), level = 0.95)
summary(emm)



simpleSlope <- emtrends(model_covariates_interactions, pairwise ~ drug_use, var = "threat", level = 0.95)
summary(simpleSlope)

```

```{r}
m_deprivation<- mean(midus$deprivation, na.rm = TRUE)
sd_deprivation<- sd(midus$deprivation, na.rm = TRUE)

emm_deprivation <- emmeans(model_covariates_interactions, pairwise ~ deprivation*drug_use, cov.keep = 3, at = list(
  deprivation = c(m_deprivation-sd_deprivation, m_deprivation, m_deprivation+sd_deprivation)), level = 0.95)
summary(emm_deprivation)



summary(emtrends(model_covariates_interactions, pairwise ~ drug_use, var = "deprivation", level = 0.95))


```

There is a lot of information here. We will first break it down by threat and deprivation. From looking at estimated means for threat, we do not see significant idfference. 


```{r}
anova(model_covariates,model_covariates_interactions,test="chi")
```

The two models are significantly different.


```{r}

model_substances <- lmer(composite_cognition ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + (1|family_id), data=midus)

summary(model_substances)
```

```{r}
model_substances_interactions <- lmer(composite_cognition ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + stimulants*threat + stimulants*deprivation + painkillers*threat + painkillers*deprivation + inhallants*threat + inhallants*deprivation + cocaine*threat + cocaine*deprivation + hallucinogens*threat + hallucinogens*deprivation + tranquilizer*threat + tranquilizer*deprivation +(1|family_id), data=midus)

summary(model_substances_interactions)
```

```{r}
anova(model_substances,model_substances_interactions,test="Chi")
```

No Significant Difference


Conclusions:




## Episodic Memory

```{r}
null_model_episodic <-lmer(episodic_memory ~ threat + deprivation + (1|family_id), data=midus)

summary(null_model_episodic)
confint(null_model_episodic, level = 0.95, method = "Wald")
plotREsim(REsim(null_model_episodic))
```

```{r}
episodic_model_covariates <- lmer(episodic_memory ~ threat + deprivation + age + sex + race + education + drug_use + (1|family_id),REML = FALSE, data=midus)

summary(episodic_model_covariates)

```


```{r}
confint(episodic_model_covariates, level = 0.95, method = "Wald")
plotREsim(REsim(episodic_model_covariates))
```

```{r}
episodic_model_covariates_interactions <- lmer(episodic_memory ~ threat + deprivation + age + sex + race + education + drug_use + threat*drug_use + deprivation*drug_use + (1|family_id), REML=FALSE,data=midus)

summary(episodic_model_covariates_interactions)
```

```{r}
anova(episodic_model_covariates,episodic_model_covariates_interactions, test="Chi")
```

```{r}
ggplot(aes(threat,episodic_memory), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```


```{r}
ggplot(aes(deprivation,episodic_memory), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```

```{r}
emm_episodic <- emmeans(episodic_model_covariates_interactions, pairwise ~ threat*drug_use, cov.keep = 3, at = list(
  threat = c(m_threat-sd_threat, m_threat, m_threat+sd_threat)), level = 0.95)
summary(emm_episodic)



summary(emtrends(episodic_model_covariates_interactions, pairwise ~ drug_use, var = "threat", level = 0.95))

```

```{r}
emm_episodic_deprivation <- emmeans(episodic_model_covariates_interactions, pairwise ~ deprivation*drug_use, cov.keep = 3, at = list(
  deprivation = c(m_deprivation-sd_deprivation, m_deprivation, m_deprivation+sd_deprivation)), level = 0.95)
summary(emm_deprivation)



summary(emtrends(episodic_model_covariates_interactions, pairwise ~ drug_use, var = "deprivation", level = 0.95))
```

```{r}
episodic_model_substances <- lmer(episodic_memory ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + (1|family_id), REML=FALSE, data=midus)

summary(episodic_model_substances)
```

```{r}
episodic_model_substances_interactions <- lmer(composite_cognition ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + stimulants*threat + stimulants*deprivation + painkillers*threat + painkillers*deprivation + inhallants*threat + inhallants*deprivation + cocaine*threat + cocaine*deprivation + hallucinogens*threat + hallucinogens*deprivation + tranquilizer*threat + tranquilizer*deprivation +(1|family_id),REML=FALSE, data=midus)

summary(episodic_model_substances_interactions)
```

```{r}
anova(episodic_model_substances,episodic_model_substances_interactions,test="Chi")
```


## Executive Function

```{r}
null_model_exec <- lmer(executive_func ~ threat + deprivation + (1|family_id), data=midus)

summary(null_model_exec)
confint(null_model_exec, level = 0.95, method = "Wald")
plotREsim(REsim(null_model_exec))

tab_model(null_model_exec)
```

```{r}
exec_model_covariates <- lmer(executive_func ~ threat + deprivation + age + sex + race + education + drug_use + (1|family_id),REML = FALSE, data=midus)

summary(exec_model_covariates)

tab_model(exec_model_covariates)

report::report(exec_model_covariates)

```

```{r}
exec_model_covariates_interactions <- lmer(executive_func ~ threat + deprivation + age + sex + race + education + drug_use + threat*drug_use + deprivation*drug_use + (1|family_id), REML=FALSE,data=midus)

summary(exec_model_covariates_interactions)
```


```{r}
anova(exec_model_covariates,exec_model_covariates_interactions)
```

```{r}
ggplot(aes(threat,executive_func), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```


```{r}
ggplot(aes(deprivation,executive_func), data = midus) + 
  geom_point() + 
  facet_wrap(~ drug_use) + 
  theme_classic()
```
```{r}
emm_exec <- emmeans(exec_model_covariates_interactions, pairwise ~ threat*drug_use, cov.keep = 3, at = list(
  threat = c(m_threat-sd_threat, m_threat, m_threat+sd_threat)), level = 0.95)
summary(emm_episodic)



summary(emtrends(exec_model_covariates_interactions, pairwise ~ drug_use, var = "threat", level = 0.95))

```

```{r}
emm_exec_deprivation <- emmeans(exec_model_covariates_interactions, pairwise ~ deprivation*drug_use, cov.keep = 3, at = list(
  deprivation = c(m_deprivation-sd_deprivation, m_deprivation, m_deprivation+sd_deprivation)), level = 0.95)
summary(emm_deprivation)



summary(emtrends(exec_model_covariates_interactions, pairwise ~ drug_use, var = "deprivation", level = 0.95))
```
```{r}
exec_model_substances <- lmer(executive_func ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + (1|family_id), REML=FALSE, data=midus)

summary(exec_model_substances)
```

```{r}
exec_substances_interactions <- lmer(executive_func ~ age + sex + education + race +tranquilizer + stimulants + painkillers + depressants + inhallants + cocaine + hallucinogens + threat+ deprivation + stimulants*threat + stimulants*deprivation + painkillers*threat + painkillers*deprivation + inhallants*threat + inhallants*deprivation + cocaine*threat + cocaine*deprivation + hallucinogens*threat + hallucinogens*deprivation + tranquilizer*threat + tranquilizer*deprivation +(1|family_id),REML=FALSE, data=midus)

summary(exec_substances_interactions)
```
```{r}
anova(exec_model_substances,exec_substances_interactions,test="chi")
```

